<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Condiciones Inseguras - Seguridad Industrial</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        /* ===== ESTILOS BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --danger: #e74c3c;
            --warning: #f39c12;
            --safe: #27ae60;
            --info: #3498db;
            --light: #f5f5f5;
            --dark: #2c3e50;
            --high-risk: #e74c3c;
            --medium-risk: #f39c12;
            --low-risk: #f1c40f;
            --critical-risk: #8e44ad;
            --pending: #e74c3c;
            --in-progress: #3498db;
            --repaired: #27ae60;
        }

        body {
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ===== HEADER ===== */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, #1a252f 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 12px rgba(44, 62, 80, 0.2);
            border-bottom: 4px solid var(--warning);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 28px;
            color: white;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }

        .logo span {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 300;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: rgba(255, 255, 255, 0.15);
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ===== LAYOUT PRINCIPAL ===== */
        .main-content {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .sidebar {
            flex: 1;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(44, 62, 80, 0.08);
            border-left: 4px solid var(--primary);
        }

        .main-panel {
            flex: 3;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* ===== COMPONENTES ===== */
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(44, 62, 80, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            border-top: 3px solid var(--light);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(44, 62, 80, 0.1);
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(44, 62, 80, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .card h2 i {
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-group label.required::after {
            content: " *";
            color: var(--danger);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.3s;
            background-color: #f9f9f9;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
            background-color: white;
        }

        .btn {
            padding: 12px 22px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1a252f;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(44, 62, 80, 0.3);
        }

        .btn-success {
            background-color: var(--safe);
            color: white;
        }

        .btn-success:hover {
            background-color: #219653;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--warning);
            color: #333;
        }

        .btn-warning:hover {
            background-color: #e67e22;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        .btn-info {
            background-color: var(--info);
            color: white;
        }

        /* ===== STATUS BADGES ===== */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pendiente {
            background-color: rgba(231, 76, 60, 0.15);
            color: var(--pending);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .status-en-proceso {
            background-color: rgba(52, 152, 219, 0.15);
            color: var(--in-progress);
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .status-reparado {
            background-color: rgba(39, 174, 96, 0.15);
            color: var(--repaired);
            border: 1px solid rgba(39, 174, 96, 0.3);
        }

        /* ===== RIESGO BADGES ===== */
        .risk-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .risk-critico {
            background-color: rgba(142, 68, 173, 0.15);
            color: var(--critical-risk);
            border: 1px solid rgba(142, 68, 173, 0.3);
        }

        .risk-alto {
            background-color: rgba(231, 76, 60, 0.15);
            color: var(--high-risk);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .risk-medio {
            background-color: rgba(243, 156, 18, 0.15);
            color: var(--medium-risk);
            border: 1px solid rgba(243, 156, 18, 0.3);
        }

        .risk-bajo {
            background-color: rgba(241, 196, 15, 0.15);
            color: var(--low-risk);
            border: 1px solid rgba(241, 196, 15, 0.3);
        }

        /* ===== CÓDIGO OT ===== */
        .ot-code {
            background-color: rgba(52, 152, 219, 0.15);
            color: var(--info);
            padding: 6px 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-weight: 700;
            font-size: 14px;
            border-left: 3px solid var(--info);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        /* ===== NAVEGACIÓN ===== */
        .nav-menu {
            list-style: none;
        }

        .nav-menu li {
            margin-bottom: 8px;
        }

        .nav-menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            border-radius: 8px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 500;
            background-color: #f9f9f9;
        }

        .nav-menu a:hover, .nav-menu a.active {
            background-color: rgba(44, 62, 80, 0.1);
            color: var(--primary);
            transform: translateX(5px);
            border-left: 3px solid var(--primary);
        }

        .nav-menu a i {
            width: 20px;
            text-align: center;
        }

        /* ===== ESTADÍSTICAS ===== */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(44, 62, 80, 0.05);
            text-align: center;
            transition: transform 0.3s;
            border-top: 4px solid var(--primary);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(44, 62, 80, 0.1);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            margin: 10px 0;
        }

        .stat-title {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        /* ===== TARJETAS DE REPORTES ===== */
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .report-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
            border-left: 4px solid var(--primary);
            position: relative;
        }

        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .ot-code-small {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--info);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            font-weight: bold;
        }

        .report-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .report-meta {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 15px 0;
        }

        .report-meta-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .report-meta-label {
            color: #7f8c8d;
            font-weight: 500;
        }

        .report-meta-value {
            color: var(--primary);
            font-weight: 600;
        }

        .report-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        /* ===== GRÁFICOS KPIs ===== */
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
            margin-top: 20px;
        }

        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .chart-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(44, 62, 80, 0.05);
            min-height: 350px;
            display: flex;
            flex-direction: column;
            border-top: 4px solid var(--warning);
        }

        .chart-item h3 {
            margin-bottom: 20px;
            text-align: center;
            color: var(--primary);
            font-weight: 600;
        }

        .chart-wrapper {
            flex: 1;
            position: relative;
        }

        /* ===== TABLAS ===== */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #eee;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th {
            background-color: var(--primary);
            color: white;
            text-align: left;
            padding: 14px 16px;
            font-weight: 600;
            position: sticky;
            top: 0;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        table th:last-child {
            border-right: none;
        }

        table td {
            padding: 14px 16px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        table tr:hover {
            background-color: rgba(44, 62, 80, 0.03);
        }

        table tr:last-child td {
            border-bottom: none;
        }

        /* ===== EVOLUCIÓN SEPARADA ===== */
        .evolution-section {
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(44, 62, 80, 0.05);
            border-top: 4px solid var(--info);
        }

        .evolution-container {
            position: relative;
            height: 350px;
            width: 100%;
            margin-top: 15px;
        }

        /* ===== MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            background: none;
            border: none;
            z-index: 3001;
            transition: all 0.3s;
        }

        .close-modal:hover {
            color: var(--primary);
            transform: scale(1.2);
        }

        /* ===== ACCIONES ===== */
        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            border: none;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }

        .action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* ===== ALERTAS ===== */
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .alert-warning {
            background-color: rgba(243, 156, 18, 0.1);
            border-left: 4px solid var(--warning);
            color: #d35400;
        }

        .alert-success {
            background-color: rgba(39, 174, 96, 0.1);
            border-left: 4px solid var(--safe);
            color: var(--safe);
        }

        .alert-danger {
            background-color: rgba(231, 76, 60, 0.1);
            border-left: 4px solid var(--danger);
            color: var(--danger);
        }

        /* ===== GESTIÓN DE IMÁGENES ===== */
        .image-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .image-upload:hover {
            border-color: var(--primary);
            background-color: rgba(44, 62, 80, 0.05);
        }

        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .image-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 6px;
            overflow: hidden;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ===== FILTROS ===== */
        .filters-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            align-items: center;
        }

        /* ===== DASHBOARD INDICATORS ===== */
        .indicator-card {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }

        .indicator-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .indicator-value {
            font-size: 32px;
            font-weight: 800;
            margin: 10px 0;
        }

        .indicator-label {
            font-size: 13px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* ===== LOADING ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== STATUS INDICATOR ===== */
        .status-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .status-connected {
            background: var(--safe);
            color: white;
        }

        .status-disconnected {
            background: var(--warning);
            color: #333;
        }

        .status-error {
            background: var(--danger);
            color: white;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1200px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
            
            .reports-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .stats-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 992px) {
            .main-content {
                flex-direction: column;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
            
            .evolution-container {
                height: 300px;
            }
            
            .chart-item {
                min-height: 300px;
            }
            
            .reports-grid {
                grid-template-columns: 1fr;
            }
            
            .btn {
                padding: 10px 18px;
                font-size: 14px;
            }
            
            .filters-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filters-container > * {
                width: 100%;
            }
        }

        @media (max-width: 576px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .card {
                padding: 20px;
            }
            
            .nav-menu a {
                padding: 12px 15px;
                font-size: 14px;
            }
            
            .report-card {
                padding: 15px;
            }
            
            .indicator-value {
                font-size: 28px;
            }
        }

        /* ===== TOUCH OPTIMIZATIONS ===== */
        .action-btn, .btn {
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            user-select: none;
        }

        /* Prevent zoom on iOS */
        input, select, textarea {
            font-size: 16px !important;
        }

        /* ===== TIMELINE ===== */
        .timeline {
            position: relative;
            padding-left: 30px;
            margin: 20px 0;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e0e0e0;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding-left: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary);
            border: 2px solid white;
            box-shadow: 0 0 0 2px var(--primary);
        }

        .timeline-date {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .timeline-content {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 6px;
            border-left: 3px solid var(--primary);
        }

        /* ===== ACCIDENT FREE DAYS ===== */
        .accident-free {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
            margin: 20px 0;
        }

        .accident-free-days {
            font-size: 48px;
            font-weight: 900;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .accident-free-label {
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
        }

        /* ===== PHOTO COMPARISON ===== */
        .photo-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .photo-container {
            text-align: center;
        }

        .photo-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .photo-box {
            width: 100%;
            height: 200px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #95a5a6;
        }

        .photo-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        @media (max-width: 768px) {
            .photo-comparison {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p id="loading-text">Conectando con la base de datos...</p>
    </div>

    <!-- Status Indicator -->
    <div id="status-indicator" class="status-indicator status-disconnected">
        <i class="fas fa-database"></i>
        <span>Desconectado</span>
    </div>

    <!-- Modal para operaciones -->
    <div id="conditionModal" class="modal">
        <button class="close-modal" onclick="cerrarModal()">&times;</button>
        <div class="modal-content">
            <div id="modal-content"></div>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <h1>Sistema de Condiciones Inseguras</h1>
                        <span>Seguridad Industrial - Gestión de Riesgos</span>
                    </div>
                </div>
                <div class="user-info">
                    <i class="fas fa-database"></i>
                    <span id="db-status">Supabase</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <nav>
                    <ul class="nav-menu">
                        <li><a href="#" class="active" data-page="dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                        <li><a href="#" data-page="nuevo-reporte"><i class="fas fa-plus-circle"></i> Nuevo Reporte</a></li>
                        <li><a href="#" data-page="historial"><i class="fas fa-history"></i> Historial</a></li>
                        <li><a href="#" data-page="analisis"><i class="fas fa-chart-pie"></i> Análisis</a></li>
                        <li><a href="#" data-page="config"><i class="fas fa-cog"></i> Configuración</a></li>
                    </ul>
                </nav>

                <!-- Información del Sistema -->
                <div class="card" style="margin-top: 30px;">
                    <h3><i class="fas fa-info-circle"></i> Información del Sistema</h3>
                    <div style="margin-top: 15px; padding: 15px; background-color: rgba(44, 62, 80, 0.05); border-radius: 6px;">
                        <p style="font-size: 12px; color: #7f8c8d; display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> <strong>Reportes activos:</strong> <span id="sidebar-active-reports">0</span>
                        </p>
                        <p style="font-size: 12px; color: #7f8c8d; display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class="fas fa-clock" style="color: var(--warning);"></i> <strong>Pendientes:</strong> <span id="sidebar-pending-reports">0</span>
                        </p>
                        <p style="font-size: 12px; color: #7f8c8d; display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class="fas fa-wrench" style="color: var(--info);"></i> <strong>En proceso:</strong> <span id="sidebar-inprogress-reports">0</span>
                        </p>
                        <p style="font-size: 12px; color: #7f8c8d; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-check-circle" style="color: var(--safe);"></i> <strong>Reparados:</strong> <span id="sidebar-repaired-reports">0</span>
                        </p>
                    </div>
                    
                    <!-- Indicador de días sin accidentes -->
                    <div class="accident-free" style="margin-top: 20px;">
                        <div class="accident-free-days" id="accident-free-days">0</div>
                        <div class="accident-free-label">Días sin accidentes</div>
                        <p style="font-size: 12px; margin-top: 10px; opacity: 0.8;">
                            Último accidente: <span id="last-accident-date">Nunca</span>
                        </p>
                    </div>
                </div>
            </aside>

            <!-- Main Panel -->
            <main class="main-panel">
                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page active">
                    <!-- Estadísticas Principales -->
                    <div class="stats-container">
                        <div class="stat-card" style="border-top-color: var(--primary);">
                            <div class="stat-title">Total de Reportes</div>
                            <div class="stat-value" id="total-reports">0</div>
                        </div>
                        <div class="stat-card" style="border-top-color: var(--danger);">
                            <div class="stat-title">Pendientes</div>
                            <div class="stat-value" id="pending-reports">0</div>
                        </div>
                        <div class="stat-card" style="border-top-color: var(--info);">
                            <div class="stat-title">En Proceso</div>
                            <div class="stat-value" id="inprogress-reports">0</div>
                        </div>
                        <div class="stat-card" style="border-top-color: var(--safe);">
                            <div class="stat-title">Reparados</div>
                            <div class="stat-value" id="repaired-reports">0</div>
                        </div>
                        <div class="stat-card" style="border-top-color: var(--warning);">
                            <div class="stat-title">Tiempo Promedio</div>
                            <div class="stat-value" id="avg-repair-time">0d</div>
                        </div>
                        <div class="stat-card" style="border-top-color: #9b59b6;">
                            <div class="stat-title">Cumplimiento Fecha</div>
                            <div class="stat-value" id="compliance-rate">0%</div>
                        </div>
                    </div>

                    <!-- Indicador de Días sin Accidentes -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h2><i class="fas fa-calendar-check"></i> Seguridad en el Trabajo</h2>
                            <button onclick="registrarAccidente()" class="btn btn-danger">
                                <i class="fas fa-exclamation"></i> Registrar Accidente
                            </button>
                        </div>
                        <div class="accident-free">
                            <div class="accident-free-days" id="dashboard-accident-days">0</div>
                            <div class="accident-free-label">Días consecutivos sin accidentes</div>
                            <div style="margin-top: 15px;">
                                <div class="timeline">
                                    <div class="timeline-item">
                                        <div class="timeline-date">Último accidente</div>
                                        <div class="timeline-content" id="last-accident-info">No se han registrado accidentes</div>
                                    </div>
                                    <div class="timeline-item">
                                        <div class="timeline-date">Record histórico</div>
                                        <div class="timeline-content">120 días sin accidentes</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Evolución Temporal -->
                    <div class="evolution-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h2><i class="fas fa-chart-line"></i> Evolución Temporal</h2>
                            <div style="display: flex; gap: 10px;">
                                <select class="form-control" id="time-period" style="width: 150px;">
                                    <option value="7d">Últimos 7 días</option>
                                    <option value="30d">Último mes</option>
                                    <option value="90d">Último trimestre</option>
                                    <option value="180d">Últimos 6 meses</option>
                                    <option value="1y">Último año</option>
                                </select>
                            </div>
                        </div>
                        <div class="evolution-container">
                            <canvas id="evolution-chart"></canvas>
                        </div>
                    </div>

                    <!-- Últimas Actividades -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h2><i class="fas fa-history"></i> Últimas Actividades</h2>
                            <button onclick="forzarActualizacion()" class="btn btn-primary" style="padding: 8px 15px;">
                                <i class="fas fa-sync-alt"></i> Actualizar
                            </button>
                        </div>
                        <div class="table-container">
                            <table id="recent-activities-table">
                                <thead>
                                    <tr>
                                        <th>OT</th>
                                        <th>Descripción</th>
                                        <th>Sector</th>
                                        <th>Tipo de Riesgo</th>
                                        <th>Fecha Estimada</th>
                                        <th>Tiempo Proceso</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Datos se cargarán aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Nuevo Reporte Page -->
                <div id="nuevo-reporte-page" class="page" style="display: none;">
                    <div class="card">
                        <h2><i class="fas fa-plus-circle"></i> Nuevo Reporte de Condición Insegura</h2>
                        <form id="report-form">
                            <!-- SECCIÓN 1: DATOS DE IDENTIFICACIÓN -->
                            <div style="background-color: rgba(44, 62, 80, 0.05); padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h3 style="color: var(--primary); font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-id-card"></i> Datos de Identificación
                                </h3>
                                
                                <div class="form-group">
                                    <label for="ot-code" class="required">Código OT *</label>
                                    <input type="text" class="form-control" id="ot-code" 
                                           placeholder="Ej: OT-2024-001" required>
                                    <small style="color: #7f8c8d; font-size: 12px;">Código único de orden de trabajo</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="reported-by" class="required">Reportado por *</label>
                                    <input type="text" class="form-control" id="reported-by" 
                                           placeholder="Nombre completo del reportante" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="report-date">Fecha del Reporte</label>
                                    <input type="datetime-local" class="form-control" id="report-date" 
                                           value="">
                                </div>
                            </div>
                            
                            <!-- SECCIÓN 2: DESCRIPCIÓN DEL PROBLEMA -->
                            <div style="background-color: rgba(231, 76, 60, 0.05); padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h3 style="color: var(--danger); font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-exclamation-circle"></i> Descripción del Problema
                                </h3>
                                
                                <div class="form-group">
                                    <label for="problem-description" class="required">Descripción *</label>
                                    <textarea class="form-control" id="problem-description" rows="4" 
                                              placeholder="Describa detalladamente la condición insegura observada..." required></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label>Evidencia Fotográfica *</label>
                                    <div class="image-upload" onclick="document.getElementById('photo-input').click()">
                                        <i class="fas fa-camera fa-2x" style="color: #7f8c8d; margin-bottom: 10px;"></i>
                                        <p>Haga clic para subir fotos o arrastre imágenes aquí</p>
                                        <p style="font-size: 12px; color: #7f8c8d;">Formatos: JPG, PNG, GIF (Máx. 5MB cada una)</p>
                                    </div>
                                    <input type="file" id="photo-input" accept="image/*" capture="environment" multiple style="display: none;" onchange="previewImages(event)">
                                    
                                    <div class="image-preview" id="image-preview">
                                        <!-- Vista previa de imágenes se cargará aquí -->
                                    </div>
                                    
                                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                                        <button type="button" class="btn btn-warning" onclick="tomarFoto()">
                                            <i class="fas fa-camera"></i> Tomar Foto
                                        </button>
                                        <button type="button" class="btn btn-info" onclick="abrirGaleria()">
                                            <i class="fas fa-images"></i> Abrir Galería
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SECCIÓN 3: UBICACIÓN Y CLASIFICACIÓN -->
                            <div style="background-color: rgba(52, 152, 219, 0.05); padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h3 style="color: var(--info); font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-map-marker-alt"></i> Ubicación y Clasificación
                                </h3>
                                
                                <div class="form-group">
                                    <label for="sector" class="required">Sector/Área *</label>
                                    <select class="form-control" id="sector" required>
                                        <option value="">Seleccione</option>
                                        <option value="Producción">Producción</option>
                                        <option value="Almacén">Almacén</option>
                                        <option value="Mantenimiento">Mantenimiento</option>
                                        <option value="Aceites">Aceites</option>
                                        <option value="Oficinas">Oficinas</option>
                                        <option value="Laboratorio">Laboratorio</option>
                                        <option value="Externo">Externo</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="specific-location" class="required">Ubicación Específica *</label>
                                    <input type="text" class="form-control" id="specific-location" 
                                           placeholder="Ej: Línea 3, Máquina X, Pasillo principal..." required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="risk-type" class="required">Tipo de Riesgo *</label>
                                    <select class="form-control" id="risk-type" required>
                                        <option value="">Seleccione</option>
                                        <option value="Mecánico">Mecánico</option>
                                        <option value="Eléctrico">Eléctrico</option>
                                        <option value="Químico">Químico</option>
                                        <option value="Ergonómico">Ergonómico</option>
                                        <option value="Físico">Físico</option>
                                        <option value="Biológico">Biológico</option>
                                        <option value="Psicosocial">Psicosocial</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="risk-level" class="required">Nivel de Riesgo *</label>
                                    <select class="form-control" id="risk-level" required>
                                        <option value="">Seleccione</option>
                                        <option value="Crítico">Crítico</option>
                                        <option value="Alto">Alto</option>
                                        <option value="Medio">Medio</option>
                                        <option value="Bajo">Bajo</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- SECCIÓN 4: PLANIFICACIÓN Y OBSERVACIÓN -->
                            <div style="background-color: rgba(39, 174, 96, 0.05); padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h3 style="color: var(--safe); font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-calendar-alt"></i> Planificación y Observación
                                </h3>
                                
                                <div class="form-group">
                                    <label for="estimated-repair-date" class="required">Fecha Estimada de Reparación *</label>
                                    <input type="date" class="form-control" id="estimated-repair-date" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="priority">Prioridad</label>
                                    <select class="form-control" id="priority">
                                        <option value="Alta">Alta</option>
                                        <option value="Media" selected>Media</option>
                                        <option value="Baja">Baja</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="additional-observations">Observaciones Adicionales</label>
                                    <textarea class="form-control" id="additional-observations" rows="3" 
                                              placeholder="Observaciones, recomendaciones, acciones inmediatas requeridas..."></textarea>
                                </div>
                            </div>
                            
                            <!-- BOTONES DE ACCIÓN -->
                            <div style="display: flex; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee; flex-wrap: wrap;">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Guardar Reporte
                                </button>
                                <button type="reset" class="btn" style="background-color: #95a5a6; color: white;">
                                    <i class="fas fa-undo"></i> Limpiar Formulario
                                </button>
                                <button type="button" class="btn btn-warning" onclick="mostrarEjemploReporte()">
                                    <i class="fas fa-eye"></i> Ver Ejemplo
                                </button>
                                <button type="button" class="btn btn-info" onclick="generarCodigoOT()">
                                    <i class="fas fa-barcode"></i> Generar Código OT
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Historial Page -->
                <div id="historial-page" class="page" style="display: none;">
                    <div class="card">
                        <h2><i class="fas fa-history"></i> Historial de Condiciones Inseguras</h2>
                        
                        <!-- Filtros y Búsqueda -->
                        <div class="filters-container">
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn btn-primary" id="filter-all">Todos</button>
                                <button class="btn btn-danger" id="filter-pending">Pendientes</button>
                                <button class="btn btn-info" id="filter-inprogress">En Proceso</button>
                                <button class="btn btn-success" id="filter-repaired">Reparados</button>
                            </div>
                            
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <select class="form-control" id="filter-sector" style="width: 150px;">
                                    <option value="">Todos los sectores</option>
                                    <option value="Producción">Producción</option>
                                    <option value="Almacén">Almacén</option>
                                    <option value="Mantenimiento">Mantenimiento</option>
                                    <option value="Aceites">Aceites</option>
                                    <option value="Oficinas">Oficinas</option>
                                </select>
                                
                                <select class="form-control" id="filter-risk-level" style="width: 150px;">
                                    <option value="">Todos los riesgos</option>
                                    <option value="Crítico">Crítico</option>
                                    <option value="Alto">Alto</option>
                                    <option value="Medio">Medio</option>
                                    <option value="Bajo">Bajo</option>
                                </select>
                                
                                <input type="text" class="form-control" id="search-reports" placeholder="Buscar por OT o descripción..." style="width: 200px;">
                                
                                <button class="btn btn-primary" onclick="exportarExcel()" title="Exportar a Excel">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                            </div>
                        </div>
                        
                        <!-- Tabla de Historial -->
                        <div class="table-container">
                            <table id="history-table">
                                <thead>
                                    <tr>
                                        <th>OT</th>
                                        <th>Descripción</th>
                                        <th>Sector</th>
                                        <th>Riesgo</th>
                                        <th>Foto Antes</th>
                                        <th>Foto Después</th>
                                        <th>Fecha</th>
                                        <th>Tiempo Reparación</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Datos se cargarán aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Análisis Page -->
                <div id="analisis-page" class="page" style="display: none;">
                    <div class="card">
                        <h2><i class="fas fa-chart-pie"></i> Análisis de Condiciones Inseguras</h2>
                        
                        <!-- Selector de período y filtros -->
                        <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <select class="form-control" id="analysis-period" style="width: 200px;">
                                <option value="30d">Último Mes</option>
                                <option value="90d">Último Trimestre</option>
                                <option value="180d">Últimos 6 Meses</option>
                                <option value="1y">Último Año</option>
                                <option value="all">Todo el Historial</option>
                            </select>
                            
                            <select class="form-control" id="analysis-type" style="width: 200px;">
                                <option value="sector">Por Sector</option>
                                <option value="risk-type">Por Tipo de Riesgo</option>
                                <option value="risk-level">Por Nivel de Riesgo</option>
                                <option value="status">Por Estado</option>
                                <option value="time">Por Tiempo de Reparación</option>
                            </select>
                            
                            <button class="btn btn-primary" onclick="actualizarAnalisis()">
                                <i class="fas fa-sync-alt"></i> Actualizar
                            </button>
                            
                            <button class="btn btn-danger" onclick="generarReportePDF()">
                                <i class="fas fa-file-pdf"></i> Generar PDF
                            </button>
                        </div>
                        
                        <!-- KPIs principales de análisis -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                            <div class="indicator-card" style="border-top: 4px solid var(--danger);">
                                <div class="indicator-label">Riesgos Críticos</div>
                                <div class="indicator-value" id="critical-risks">0</div>
                            </div>
                            
                            <div class="indicator-card" style="border-top: 4px solid var(--warning);">
                                <div class="indicator-label">Riesgos Altos</div>
                                <div class="indicator-value" id="high-risks">0</div>
                            </div>
                            
                            <div class="indicator-card" style="border-top: 4px solid var(--info);">
                                <div class="indicator-label">Tiempo Promedio</div>
                                <div class="indicator-value" id="avg-repair-time-analysis">0d</div>
                            </div>
                            
                            <div class="indicator-card" style="border-top: 4px solid var(--safe);">
                                <div class="indicator-label">Tasa de Cumplimiento</div>
                                <div class="indicator-value" id="compliance-rate-analysis">0%</div>
                            </div>
                        </div>
                        
                        <!-- Gráficos de Análisis -->
                        <div class="chart-row">
                            <div class="chart-item">
                                <h3><i class="fas fa-chart-bar"></i> Distribución por Sector</h3>
                                <div class="chart-wrapper">
                                    <canvas id="sector-chart"></canvas>
                                </div>
                            </div>
                            <div class="chart-item">
                                <h3><i class="fas fa-chart-pie"></i> Distribución por Nivel de Riesgo</h3>
                                <div class="chart-wrapper">
                                    <canvas id="risk-level-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-row" style="margin-top: 20px;">
                            <div class="chart-item">
                                <h3><i class="fas fa-chart-line"></i> Tendencias Temporales</h3>
                                <div class="chart-wrapper">
                                    <canvas id="trend-chart"></canvas>
                                </div>
                            </div>
                            <div class="chart-item">
                                <h3><i class="fas fa-chart-bar"></i> Tiempos de Reparación</h3>
                                <div class="chart-wrapper">
                                    <canvas id="repair-time-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Top Sectores con más reportes -->
                        <div style="margin-top: 30px;">
                            <h3><i class="fas fa-exclamation-triangle"></i> Sectores con Más Reportes</h3>
                            <div class="table-container" style="margin-top: 15px;">
                                <table id="top-sectors-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Sector</th>
                                            <th>Total Reportes</th>
                                            <th>Pendientes</th>
                                            <th>En Proceso</th>
                                            <th>Reparados</th>
                                            <th>Tiempo Promedio</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Datos se cargarán aquí -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuración Page -->
                <div id="config-page" class="page" style="display: none;">
                    <div class="card">
                        <h2><i class="fas fa-cog"></i> Configuración del Sistema</h2>
                        
                        <!-- Información del Sistema -->
                        <div style="margin-top: 30px;">
                            <h3><i class="fas fa-info-circle"></i> Información del Sistema</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 10px; border-left: 4px solid var(--primary);">
                                <p style="margin-bottom: 8px;"><strong><i class="fas fa-exclamation-triangle" style="color: var(--primary);"></i> Total reportes:</strong> <span id="total-reports-config">0</span></p>
                                <p style="margin-bottom: 8px;"><strong><i class="fas fa-clock" style="color: var(--warning);"></i> Reportes pendientes:</strong> <span id="pending-reports-config">0</span></p>
                                <p style="margin-bottom: 8px;"><strong><i class="fas fa-users" style="color: var(--accent);"></i> Reportantes activos:</strong> <span id="active-reporters">0</span></p>
                                <p style="margin-bottom: 8px;"><strong><i class="fas fa-calendar" style="color: var(--safe);"></i> Días sin accidentes:</strong> <span id="accident-free-config">0</span></p>
                                <p style="margin-bottom: 8px;"><strong><i class="fas fa-sync-alt" style="color: #3498db;"></i> Última sincronización:</strong> <span id="last-sync">Nunca</span></p>
                                <p><strong><i class="fas fa-code-branch" style="color: var(--dark);"></i> Versión:</strong> Seguridad v3.0</p>
                            </div>
                        </div>
                        
                        <!-- Herramientas de Sistema -->
                        <div style="margin-top: 30px;">
                            <h3><i class="fas fa-tools"></i> Herramientas de Sistema</h3>
                            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                                <button class="btn btn-danger" onclick="limpiarDatos()">
                                    <i class="fas fa-trash"></i> Limpiar Datos Locales
                                </button>
                                <button class="btn btn-warning" onclick="resetConfig()">
                                    <i class="fas fa-redo"></i> Resetear Configuración
                                </button>
                                <button class="btn btn-info" onclick="backupLocal()">
                                    <i class="fas fa-download"></i> Backup Local
                                </button>
                                <button class="btn btn-success" onclick="simularDatos()">
                                    <i class="fas fa-database"></i> Simular Datos
                                </button>
                            </div>
                        </div>
                        
                        <!-- Configuración de Notificaciones -->
                        <div style="margin-top: 30px;">
                            <h3><i class="fas fa-bell"></i> Configuración de Notificaciones</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 10px;">
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="notify-new" checked> Notificar nuevos reportes
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="notify-overdue" checked> Notificar reportes vencidos
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="notify-critical" checked> Notificar riesgos críticos
                                    </label>
                                </div>
                                <button class="btn btn-primary" onclick="guardarNotificaciones()">
                                    <i class="fas fa-save"></i> Guardar Configuración
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        
        <footer style="text-align: center; margin-top: 30px; padding: 20px; color: #7f8c8d; border-top: 1px solid #eee; background-color: rgba(44, 62, 80, 0.05);">
            <p><strong>Sistema de Gestión de Condiciones Inseguras Danec</strong> &copy; 2026 | Versión 3.0 | Seguridad Industrial</p>
            <p style="font-size: 12px; margin-top: 5px;">Niveles de Riesgo: Crítico, Alto, Medio, Bajo | Protocolo de acción inmediata</p>
        </footer>
    </div>

    <script>
        // ==============================================
        // CONFIGURACIÓN GLOBAL
        // ==============================================
        let supabaseClient = null;
        let reports = [];
        let movements = [];
        let accidents = [];
        let currentFilter = 'all';
        let evolutionChart = null;
        let sectorChart = null;
        let riskLevelChart = null;
        let trendChart = null;
        let repairTimeChart = null;
        let cameraStream = null;
        
        // CREDENCIALES DE SUPABASE
        const MIS_CREDENCIALES = {
            URL: 'https://dvijgsezdxehnappichq.supabase.co',
            API_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2aWpnc2V6ZHhlaG5hcHBpY2hxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwOTI5MDAsImV4cCI6MjA4NDY2ODkwMH0.nb6mFkfmPJmIV1t--Uo4wK7BE84ZOTA0W8gF-5FUzD8'
        };
        
        const BUCKET_NAME = 'evidencias-condiciones';
        
        let CONFIG = {
            supabaseUrl: MIS_CREDENCIALES.URL,
            supabaseKey: MIS_CREDENCIALES.API_KEY,
            lastSync: 'Nunca',
            offlineMode: true,
            initialized: false,
            notifications: {
                new: true,
                overdue: true,
                critical: true
            }
        };
        
        // Colores para gráficos
        const CHART_COLORS = {
            status: {
                'Pendiente': '#e74c3c',
                'En Proceso': '#3498db',
                'Reparado': '#27ae60'
            },
            risk: {
                'Crítico': '#8e44ad',
                'Alto': '#e74c3c',
                'Medio': '#f39c12',
                'Bajo': '#f1c40f'
            },
            sector: {
                'Producción': '#3498db',
                'Almacén': '#2ecc71',
                'Mantenimiento': '#e74c3c',
                'Aceites': '#f39c12',
                'Oficinas': '#9b59b6',
                'Laboratorio': '#1abc9c',
                'Externo': '#95a5a6'
            }
        };
        
        // ==============================================
        // FUNCIONES DE UTILIDAD
        // ==============================================
        function showLoading(show, text = 'Cargando...') {
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loading-text');
            
            if (loading) loading.style.display = show ? 'flex' : 'none';
            if (loadingText && text) loadingText.textContent = text;
        }
        
        function updateStatusIndicator(status, message) {
            const indicator = document.getElementById('status-indicator');
            if (!indicator) return;
            
            indicator.classList.remove('status-connected', 'status-disconnected', 'status-error');
            indicator.classList.add(`status-${status}`);
            
            let icon = 'fa-database';
            if (status === 'connected') icon = 'fa-check-circle';
            if (status === 'error') icon = 'fa-exclamation-triangle';
            if (status === 'disconnected') icon = 'fa-unlink';
            
            indicator.innerHTML = `<i class="fas ${icon}"></i> <span>${message}</span>`;
            
            const dbStatus = document.getElementById('db-status');
            if (dbStatus) {
                dbStatus.textContent = status === 'connected' ? 'Conectado a Danec ✓' : 'Desconectado ✗';
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }
        
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }
        
        function obtenerTimestamp() {
            return new Date().toISOString();
        }
        
        function generarCodigoOT() {
            const year = new Date().getFullYear();
            const numerosUsados = reports
                .filter(r => r.ot && r.ot.match(/OT-\d{4}-\d{3}/))
                .map(r => {
                    const match = r.ot.match(/OT-\d{4}-(\d{3})/);
                    return match ? parseInt(match[1]) : 0;
                })
                .filter(n => !isNaN(n));
            
            let siguienteNumero = 1;
            if (numerosUsados.length > 0) {
                const maxNumero = Math.max(...numerosUsados);
                siguienteNumero = maxNumero + 1;
            }
            
            const otCode = `OT-${year}-${String(siguienteNumero).padStart(3, '0')}`;
            document.getElementById('ot-code').value = otCode;
            
            const otField = document.getElementById('ot-code');
            otField.style.borderColor = '#27ae60';
            otField.style.boxShadow = '0 0 0 3px rgba(39, 174, 96, 0.2)';
            
            setTimeout(() => {
                otField.style.borderColor = '';
                otField.style.boxShadow = '';
            }, 1500);
        }
        
        function mostrarEjemploReporte() {
            const hoy = new Date();
            const mañana = new Date(hoy);
            mañana.setDate(mañana.getDate() + 3);
            
            document.getElementById('ot-code').value = 'OT-2024-001';
            document.getElementById('reported-by').value = 'Juan Pérez';
            document.getElementById('report-date').value = hoy.toISOString().slice(0, 16);
            document.getElementById('problem-description').value = 'Cable eléctrico expuesto en el pasillo principal del área de producción. Presenta riesgo de electrocución para el personal.';
            document.getElementById('sector').value = 'Producción';
            document.getElementById('specific-location').value = 'Línea 3, Pasillo principal, cerca de la máquina de inyección';
            document.getElementById('risk-type').value = 'Eléctrico';
            document.getElementById('risk-level').value = 'Alto';
            document.getElementById('estimated-repair-date').value = mañana.toISOString().split('T')[0];
            document.getElementById('priority').value = 'Alta';
            document.getElementById('additional-observations').value = 'Se requiere aislamiento inmediato del área. Notificar al supervisor de mantenimiento.';
            
            alert('📝 Ejemplo cargado. Revisa los datos y modifica según sea necesario.');
        }
        
        function calcularDiasSinAccidentes() {
            if (accidents.length === 0) {
                const diasGuardados = localStorage.getItem('ultimo_accidente_dias');
                if (diasGuardados && diasGuardados !== "365") {
                    return parseInt(diasGuardados);
                }
                return 365;
            }
            
            const ultimoAccidente = accidents.sort((a, b) => new Date(b.fecha) - new Date(a.fecha))[0];
            const hoy = new Date();
            const ultimaFecha = new Date(ultimoAccidente.fecha);
            const diferenciaMs = hoy - ultimaFecha;
            const diferenciaDias = Math.floor(diferenciaMs / (1000 * 60 * 60 * 24));
            
            localStorage.setItem('ultimo_accidente_dias', diferenciaDias);
            
            return diferenciaDias;
        }
        
        function calcularTiempoPromedioReparacion() {
            const reparados = reports.filter(r => {
                if (r.estado !== 'Reparado') return false;
                if (!r.fecha_reparacion || !r.fecha_reporte) return false;
                
                const fechaInicio = new Date(r.fecha_reporte);
                const fechaFin = new Date(r.fecha_reparacion);
                
                if (fechaFin <= fechaInicio) return false;
                if (isNaN(fechaInicio.getTime()) || isNaN(fechaFin.getTime())) return false;
                
                return true;
            });
            
            if (reparados.length === 0) return 0;
            
            const totalDias = reparados.reduce((sum, reporte) => {
                const inicio = new Date(reporte.fecha_reporte);
                const fin = new Date(reporte.fecha_reparacion);
                const diferenciaMs = fin.getTime() - inicio.getTime();
                const dias = Math.max(0, Math.floor(diferenciaMs / (1000 * 60 * 60 * 24)));
                return sum + dias;
            }, 0);
            
            return Math.round(totalDias / reparados.length);
        }
        
        function calcularTasaCumplimiento() {
            const reparados = reports.filter(r => r.estado === 'Reparado');
            if (reparados.length === 0) return 0;
            
            const cumplidos = reparados.filter(r => {
                if (!r.fecha_estimada_reparacion || !r.fecha_reparacion) return false;
                const estimada = new Date(r.fecha_estimada_reparacion);
                const real = new Date(r.fecha_reparacion);
                return real <= estimada;
            });
            
            return Math.round((cumplidos.length / reparados.length) * 100);
        }
        
        function obtenerEstadoClase(estado) {
            switch(estado) {
                case 'Pendiente': return 'status-pendiente';
                case 'En Proceso': return 'status-en-proceso';
                case 'Reparado': return 'status-reparado';
                default: return '';
            }
        }
        
        function obtenerRiesgoClase(riesgo) {
            switch(riesgo) {
                case 'Crítico': return 'risk-critico';
                case 'Alto': return 'risk-alto';
                case 'Medio': return 'risk-medio';
                case 'Bajo': return 'risk-bajo';
                default: return '';
            }
        }
        
        // ==============================================
        // FUNCIONES PARA MANEJO DE IMÁGENES
        // ==============================================
        function previewImages(event) {
            const preview = document.getElementById('image-preview');
            preview.innerHTML = '';
            
            const files = event.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'image-preview-item';
                    imgContainer.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button class="remove-image" onclick="removerImagen(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    preview.appendChild(imgContainer);
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        function removerImagen(button) {
            const container = button.parentElement;
            container.remove();
        }
        
        function removerImagenReparacion(button) {
            const container = button.parentElement;
            container.remove();
        }
        
        function tomarFoto() {
            alert('📸 Función de tomar foto disponible en dispositivos móviles con cámara');
            document.getElementById('photo-input').click();
        }
        
        function abrirGaleria() {
            document.getElementById('photo-input').click();
        }
        
        function ampliarFoto(url) {
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div style="text-align: center;">
                    <h3 style="margin-bottom: 15px;"><i class="fas fa-camera"></i> Vista Ampliada</h3>
                    <img src="${url}" 
                         style="max-width: 100%; max-height: 70vh; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);"
                         alt="Foto ampliada">
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="window.open('${url}', '_blank')">
                            <i class="fas fa-external-link-alt"></i> Abrir en nueva pestaña
                        </button>
                        <button class="btn btn-secondary" onclick="cerrarModal()" style="margin-left: 10px;">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('conditionModal').style.display = 'flex';
        }
        
        async function subirFotoASupabase(file, ot, tipo = 'antes') {
            try {
                console.log(`📤 Subiendo foto para OT: ${ot}, Tipo: ${tipo}`);
                
                if (!supabaseClient) {
                    throw new Error('No hay conexión con Supabase');
                }
                
                // Verificar que el bucket existe
                const { data: buckets, error: bucketsError } = await supabaseClient.storage.listBuckets();
                if (bucketsError) {
                    // Intentar crear el bucket
                    const { error: createError } = await supabaseClient.storage.createBucket(BUCKET_NAME, {
                        public: true,
                        fileSizeLimit: 5242880
                    });
                    if (createError) {
                        if (!createError.message.includes('already exists')) {
                            throw createError;
                        }
                    }
                }
                
                // Generar nombre seguro
                const timestamp = Date.now();
                const randomId = Math.random().toString(36).substring(2, 9);
                const safeOT = ot.replace(/[^a-zA-Z0-9]/g, '_');
                const extension = file.name.split('.').pop().toLowerCase();
                const fileName = `${safeOT}_${tipo}_${timestamp}_${randomId}.${extension}`;
                
                console.log('📄 Subiendo archivo:', fileName);
                
                // Subir con opciones específicas
                const { data: uploadData, error: uploadError } = await supabaseClient.storage
                    .from(BUCKET_NAME)
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: true,
                        contentType: file.type
                    });
                
                if (uploadError) {
                    console.error('❌ Error en upload:', uploadError);
                    throw uploadError;
                }
                
                console.log('✅ Archivo subido:', uploadData);
                
                // Obtener URL pública CORRECTA
                const { data: { publicUrl } } = supabaseClient.storage
                    .from(BUCKET_NAME)
                    .getPublicUrl(fileName);
                
                console.log('🔗 URL pública obtenida:', publicUrl);
                
                return {
                    success: true,
                    url: publicUrl,
                    fileName: fileName
                };
                
            } catch (error) {
                console.error('❌ Error subiendo foto:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        // ==============================================
        // FUNCIONES DE NAVEGACIÓN
        // ==============================================
        function cambiarPagina(pagina) {
            document.querySelectorAll('.page').forEach(p => {
                p.style.display = 'none';
                p.classList.remove('active');
            });
            
            const pageElement = document.getElementById(`${pagina}-page`);
            if (pageElement) {
                pageElement.style.display = 'block';
                pageElement.classList.add('active');
            }
            
            document.querySelectorAll('.nav-menu a').forEach(a => {
                a.classList.remove('active');
                if (a.getAttribute('data-page') === pagina) {
                    a.classList.add('active');
                }
            });
            
            switch(pagina) {
                case 'dashboard':
                    cargarDashboard();
                    break;
                case 'historial':
                    cargarHistorial();
                    break;
                case 'analisis':
                    cargarAnalisis();
                    break;
                case 'config':
                    cargarConfiguracion();
                    break;
            }
        }
        
        // ==============================================
        // FUNCIONES PARA DASHBOARD
        // ==============================================
        async function cargarDashboard() {
            try {
                actualizarEstadisticasDashboard();
                actualizarDiasSinAccidentes();
                cargarActividadesRecientes();
                actualizarGraficoEvolucion();
            } catch (error) {
                console.error('Error cargando dashboard:', error);
            }
        }
        
        function actualizarEstadisticasDashboard() {
            const total = reports.length;
            const pendientes = reports.filter(r => r.estado === 'Pendiente').length;
            const enProceso = reports.filter(r => r.estado === 'En Proceso').length;
            const reparados = reports.filter(r => r.estado === 'Reparado').length;
            const tiempoPromedio = calcularTiempoPromedioReparacion();
            const cumplimiento = calcularTasaCumplimiento();
            
            document.getElementById('total-reports').textContent = total;
            document.getElementById('pending-reports').textContent = pendientes;
            document.getElementById('inprogress-reports').textContent = enProceso;
            document.getElementById('repaired-reports').textContent = reparados;
            document.getElementById('avg-repair-time').textContent = `${tiempoPromedio}d`;
            document.getElementById('compliance-rate').textContent = `${cumplimiento}%`;
            
            document.getElementById('sidebar-active-reports').textContent = total;
            document.getElementById('sidebar-pending-reports').textContent = pendientes;
            document.getElementById('sidebar-inprogress-reports').textContent = enProceso;
            document.getElementById('sidebar-repaired-reports').textContent = reparados;
        }
        
        function actualizarDiasSinAccidentes() {
            const diasSinAccidentes = calcularDiasSinAccidentes();
            document.getElementById('accident-free-days').textContent = diasSinAccidentes;
            document.getElementById('dashboard-accident-days').textContent = diasSinAccidentes;
            
            if (accidents.length > 0) {
                const ultimoAccidente = accidents.sort((a, b) => new Date(b.fecha) - new Date(a.fecha))[0];
                document.getElementById('last-accident-date').textContent = formatDate(ultimoAccidente.fecha);
                document.getElementById('last-accident-info').textContent = `${ultimoAccidente.descripcion} (${formatDate(ultimoAccidente.fecha)})`;
            }
        }
        
        function cargarActividadesRecientes() {
            const tbody = document.querySelector('#recent-activities-table tbody');
            if (!tbody) return;
            
            const recientes = [...reports]
                .sort((a, b) => new Date(b.fecha_reporte) - new Date(a.fecha_reporte))
                .slice(0, 10);
            
            tbody.innerHTML = '';
            
            recientes.forEach(reporte => {
                let tiempoProceso = 'N/A';
                if (reporte.estado === 'Reparado' && reporte.fecha_reparacion) {
                    const inicio = new Date(reporte.fecha_reporte);
                    const fin = new Date(reporte.fecha_reparacion);
                    const dias = Math.floor((fin - inicio) / (1000 * 60 * 60 * 24));
                    tiempoProceso = `${dias} días`;
                } else if (reporte.estado === 'En Proceso') {
                    const inicio = new Date(reporte.fecha_reporte);
                    const hoy = new Date();
                    const dias = Math.floor((hoy - inicio) / (1000 * 60 * 60 * 24));
                    tiempoProceso = `${dias} días (en curso)`;
                }
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="ot-code">${reporte.ot}</span></td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${reporte.descripcion}">
                        ${reporte.descripcion.substring(0, 50)}${reporte.descripcion.length > 50 ? '...' : ''}
                    </td>
                    <td>${reporte.sector}</td>
                    <td>${reporte.tipo_riesgo}</td>
                    <td>${formatDate(reporte.fecha_estimada_reparacion)}</td>
                    <td>${tiempoProceso}</td>
                    <td><span class="status-badge ${obtenerEstadoClase(reporte.estado)}">${reporte.estado}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function actualizarGraficoEvolucion() {
    const ctx = document.getElementById('evolution-chart');
    if (!ctx) return;
    
    if (evolutionChart) {
        evolutionChart.destroy();
    }
    
    const periodo = document.getElementById('time-period').value;
    let dias = 30;
    if (periodo === '7d') dias = 7;
    if (periodo === '90d') dias = 90;
    if (periodo === '180d') dias = 180;
    if (periodo === '1y') dias = 365;
    
    const hoy = new Date();
    const fechas = [];
    const datosNuevosReportes = []; // Cambiado de datosPendientes
    const datosReparados = [];
    
    // Crear array de fechas
    for (let i = dias - 1; i >= 0; i--) {
        const fecha = new Date(hoy);
        fecha.setDate(fecha.getDate() - i);
        const fechaStr = fecha.toISOString().split('T')[0];
        
        // Formatear para mostrar en el gráfico
        if (dias <= 30) {
            // Para períodos cortos, mostrar día-mes
            fechas.push(fecha.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }));
        } else if (dias <= 90) {
            // Para períodos medianos, mostrar día cada 3 días
            if (i % 3 === 0) {
                fechas.push(fecha.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }));
            } else {
                fechas.push('');
            }
        } else {
            // Para períodos largos, mostrar semana
            if (i % 7 === 0) {
                fechas.push(`Sem ${Math.floor(i/7)}`);
            } else {
                fechas.push('');
            }
        }
        
        // Contar NUEVOS reportes creados en esta fecha (sin importar estado)
        const nuevosReportes = reports.filter(r => {
            if (!r.fecha_reporte) return false;
            const reporteFecha = new Date(r.fecha_reporte);
            const reporteFechaStr = reporteFecha.toISOString().split('T')[0];
            return reporteFechaStr === fechaStr;
        }).length;
        
        datosNuevosReportes.push(nuevosReportes);
        
        // Contar reportes REPARADOS en esta fecha
        const reparados = reports.filter(r => {
            if (r.estado !== 'Reparado' || !r.fecha_reparacion) return false;
            const reparacionFecha = new Date(r.fecha_reparacion);
            const reparacionFechaStr = reparacionFecha.toISOString().split('T')[0];
            return reparacionFechaStr === fechaStr;
        }).length;
        
        datosReparados.push(reparados);
    }
    
    // Para períodos largos, filtrar fechas vacías
    let labelsFinal = fechas;
    let nuevosFinal = datosNuevosReportes;
    let reparadosFinal = datosReparados;
    
    if (dias > 30) {
        // Filtrar solo las fechas no vacías
        labelsFinal = [];
        nuevosFinal = [];
        reparadosFinal = [];
        
        for (let i = 0; i < fechas.length; i++) {
            if (fechas[i] !== '') {
                labelsFinal.push(fechas[i]);
                nuevosFinal.push(datosNuevosReportes[i]);
                reparadosFinal.push(datosReparados[i]);
            }
        }
    }
    
    evolutionChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labelsFinal,
            datasets: [
                {
                    label: 'Nuevos Reportes',
                    data: nuevosFinal,
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                },
                {
                    label: 'Reparados',
                    data: reparadosFinal,
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: '#2c3e50',
                        font: {
                            size: 12,
                            weight: 'bold'
                        },
                        padding: 20
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(44, 62, 80, 0.9)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: '#2c3e50',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += context.parsed.y + ' reporte' + (context.parsed.y !== 1 ? 's' : '');
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#7f8c8d',
                        font: {
                            size: 11
                        },
                        callback: function(value) {
                            if (value % 1 === 0) {
                                return value;
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Cantidad de Reportes',
                        color: '#2c3e50',
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#2c3e50',
                        font: {
                            size: 11
                        },
                        maxRotation: 45
                    },
                    title: {
                        display: true,
                        text: 'Período de Tiempo',
                        color: '#2c3e50',
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'nearest'
            },
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    });
    
    // También actualizamos el gráfico cuando se cambia el período
    document.getElementById('time-period').addEventListener('change', function() {
        actualizarGraficoEvolucion();
        mostrarNotificacion('✅ Gráfico de evolución actualizado', 'success');
    });
}
        
        // ==============================================
        // FUNCIONES PARA NUEVO REPORTE
        // ==============================================
        async function manejarRegistroReporte(event) {
            event.preventDefault();
            
            showLoading(true, 'Guardando reporte...');
            
            try {
                // 1. Datos básicos
                const nuevoReporte = {
                    ot: document.getElementById('ot-code').value,
                    reportado_por: document.getElementById('reported-by').value,
                    descripcion: document.getElementById('problem-description').value,
                    sector: document.getElementById('sector').value,
                    ubicacion_especifica: document.getElementById('specific-location').value,
                    tipo_riesgo: document.getElementById('risk-type').value,
                    nivel_riesgo: document.getElementById('risk-level').value,
                    fecha_estimada_reparacion: document.getElementById('estimated-repair-date').value,
                    prioridad: document.getElementById('priority').value,
                    observaciones: document.getElementById('additional-observations').value,
                    estado: 'Pendiente'
                };
                
                // 2. Guardar en Supabase
                const { data, error } = await supabaseClient
                    .from('condiciones_inseguras')
                    .upsert([nuevoReporte], { onConflict: 'ot' });
                
                if (error) throw error;
                
                // 3. Subir fotos si hay
                const imagePreviews = document.querySelectorAll('#image-preview .image-preview-item img');
                const fotosUrls = [];
                
                for (const img of imagePreviews) {
                    const blob = await (await fetch(img.src)).blob();
                    const file = new File([blob], `foto_${Date.now()}.jpg`, { type: 'image/jpeg' });
                    
                    const result = await subirFotoASupabase(file, nuevoReporte.ot, 'antes');
                    if (result.success) {
                        fotosUrls.push(result.url);
                    }
                }
                
                // 4. Actualizar con URLs de fotos
                if (fotosUrls.length > 0) {
                    await supabaseClient
                        .from('condiciones_inseguras')
                        .update({ fotos_antes: fotosUrls })
                        .eq('ot', nuevoReporte.ot);
                }
                
                alert(`✅ Reporte ${nuevoReporte.ot} guardado!`);
                
                // 5. Limpiar y volver
                event.target.reset();
                document.getElementById('image-preview').innerHTML = '';
                cambiarPagina('dashboard');
                
            } catch (error) {
                console.error('Error:', error);
                alert('❌ Error: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // ==============================================
        // FUNCIONES PARA HISTORIAL
        // ==============================================
        function cargarHistorial() {
            const tbody = document.querySelector('#history-table tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            let reportesFiltrados = [...reports];
            
            const filterSector = document.getElementById('filter-sector').value;
            if (filterSector) {
                reportesFiltrados = reportesFiltrados.filter(r => r.sector === filterSector);
            }
            
            const filterRisk = document.getElementById('filter-risk-level').value;
            if (filterRisk) {
                reportesFiltrados = reportesFiltrados.filter(r => r.nivel_riesgo === filterRisk);
            }
            
            const searchTerm = document.getElementById('search-reports').value.toLowerCase();
            if (searchTerm) {
                reportesFiltrados = reportesFiltrados.filter(r => 
                    (r.ot && r.ot.toLowerCase().includes(searchTerm)) ||
                    (r.descripcion && r.descripcion.toLowerCase().includes(searchTerm)) ||
                    (r.reportado_por && r.reportado_por.toLowerCase().includes(searchTerm))
                );
            }
            
            if (currentFilter === 'pending') {
                reportesFiltrados = reportesFiltrados.filter(r => r.estado === 'Pendiente');
            } else if (currentFilter === 'inprogress') {
                reportesFiltrados = reportesFiltrados.filter(r => r.estado === 'En Proceso');
            } else if (currentFilter === 'repaired') {
                reportesFiltrados = reportesFiltrados.filter(r => r.estado === 'Reparado');
            }
            
            reportesFiltrados.sort((a, b) => new Date(b.fecha_reporte) - new Date(a.fecha_reporte));
            
            reportesFiltrados.forEach(reporte => {
                let tiempoReparacion = 'N/A';
                if (reporte.estado === 'Reparado' && reporte.fecha_reparacion) {
                    const inicio = new Date(reporte.fecha_reporte);
                    const fin = new Date(reporte.fecha_reparacion);
                    const dias = Math.floor((fin - inicio) / (1000 * 60 * 60 * 24));
                    tiempoReparacion = `${dias} días`;
                }
                
                // Columna Foto Antes
                let fotoAntesHTML = '<i class="fas fa-times" style="color: #95a5a6;"></i> Sin foto';
                if (reporte.fotos_antes && reporte.fotos_antes.length > 0) {
                    fotoAntesHTML = `
                        <div style="position: relative;">
                            <img src="${reporte.fotos_antes[0]}" 
                                 style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; cursor: pointer;"
                                 onclick="ampliarFoto('${reporte.fotos_antes[0]}')"
                                 title="Click para ampliar">
                            ${reporte.fotos_antes.length > 1 ? 
                                `<span style="position: absolute; top: -5px; right: -5px; background: #3498db; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; display: flex; align-items: center; justify-content: center;">
                                    +${reporte.fotos_antes.length - 1}
                                </span>` : ''}
                        </div>
                    `;
                }
                
                // Columna Foto Después
                let fotoDespuesHTML = '<i class="fas fa-times" style="color: #95a5a6;"></i> Sin foto';
                if (reporte.fotos_despues && reporte.fotos_despues.length > 0) {
                    fotoDespuesHTML = `
                        <div style="position: relative;">
                            <img src="${reporte.fotos_despues[0]}" 
                                 style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; cursor: pointer;"
                                 onclick="ampliarFoto('${reporte.fotos_despues[0]}')"
                                 title="Click para ampliar">
                            ${reporte.fotos_despues.length > 1 ? 
                                `<span style="position: absolute; top: -5px; right: -5px; background: #27ae60; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; display: flex; align-items: center; justify-content: center;">
                                    +${reporte.fotos_despues.length - 1}
                                </span>` : ''}
                        </div>
                    `;
                }
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="ot-code">${reporte.ot}</span></td>
                    <td style="max-width: 150px;" title="${reporte.descripcion}">
                        ${reporte.descripcion.substring(0, 50)}${reporte.descripcion.length > 50 ? '...' : ''}
                    </td>
                    <td>${reporte.sector}</td>
                    <td><span class="risk-badge ${obtenerRiesgoClase(reporte.nivel_riesgo)}">${reporte.nivel_riesgo}</span></td>
                    <td>${fotoAntesHTML}</td>
                    <td>${fotoDespuesHTML}</td>
                    <td>${formatDate(reporte.fecha_reporte)}</td>
                    <td>${tiempoReparacion}</td>
                    <td><span class="status-badge ${obtenerEstadoClase(reporte.estado)}">${reporte.estado}</span></td>
                    <td>
                        <div class="actions">
                            <button class="action-btn btn-info" onclick="verDetalleReporte('${reporte.ot}')" title="Ver Detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${reporte.estado === 'Pendiente' ? 
                                `<button class="action-btn btn-primary" onclick="cambiarEstado('${reporte.ot}', 'En Proceso')" title="Iniciar Proceso">
                                    <i class="fas fa-play"></i>
                                </button>` : ''}
                            ${reporte.estado === 'En Proceso' ? 
                                `<button class="action-btn btn-success" onclick="marcarComoReparado('${reporte.ot}')" title="Marcar como Reparado">
                                    <i class="fas fa-check"></i>
                                </button>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function verDetalleReporte(ot) {
            const reporte = reports.find(r => r.ot === ot);
            if (!reporte) return;
            
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <h3 style="margin-bottom: 20px;"><i class="fas fa-info-circle"></i> Detalle del Reporte ${ot}</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4 style="color: var(--primary); margin-bottom: 10px;">Información Básica</h4>
                        <p><strong>Reportado por:</strong> ${reporte.reportado_por}</p>
                        <p><strong>Fecha:</strong> ${formatDateTime(reporte.fecha_reporte)}</p>
                        <p><strong>Sector:</strong> ${reporte.sector}</p>
                        <p><strong>Ubicación:</strong> ${reporte.ubicacion_especifica}</p>
                    </div>
                    <div>
                        <h4 style="color: var(--primary); margin-bottom: 10px;">Clasificación</h4>
                        <p><strong>Tipo de riesgo:</strong> ${reporte.tipo_riesgo}</p>
                        <p><strong>Nivel de riesgo:</strong> <span class="risk-badge ${obtenerRiesgoClase(reporte.nivel_riesgo)}">${reporte.nivel_riesgo}</span></p>
                        <p><strong>Estado:</strong> <span class="status-badge ${obtenerEstadoClase(reporte.estado)}">${reporte.estado}</span></p>
                        <p><strong>Prioridad:</strong> ${reporte.prioridad}</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Descripción</h4>
                    <p style="background: #f8f9fa; padding: 15px; border-radius: 6px;">${reporte.descripcion}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Fotos</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h5 style="color: #3498db;">Antes</h5>
                            ${reporte.fotos_antes && reporte.fotos_antes.length > 0 ? 
                                `<img src="${reporte.fotos_antes[0]}" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 6px;">` : 
                                '<p style="color: #95a5a6; text-align: center;">No hay fotos</p>'}
                        </div>
                        <div>
                            <h5 style="color: #27ae60;">Después</h5>
                            ${reporte.fotos_despues && reporte.fotos_despues.length > 0 ? 
                                `<img src="${reporte.fotos_despues[0]}" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 6px;">` : 
                                '<p style="color: #95a5a6; text-align: center;">No hay fotos</p>'}
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="cerrarModal()">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            `;
            
            document.getElementById('conditionModal').style.display = 'flex';
        }
        
        async function cambiarEstado(ot, nuevoEstado) {
            const reporte = reports.find(r => r.ot === ot);
            if (!reporte) return;
            
            reporte.estado = nuevoEstado;
            
            if (nuevoEstado === 'En Proceso') {
                reporte.fecha_inicio_proceso = obtenerTimestamp();
            }
            
            // Actualizar en Supabase
            const { error } = await supabaseClient
                .from('condiciones_inseguras')
                .update({ 
                    estado: nuevoEstado,
                    fecha_inicio_proceso: nuevoEstado === 'En Proceso' ? obtenerTimestamp() : null
                })
                .eq('ot', ot);
            
            if (error) {
                console.error('Error actualizando estado:', error);
                return;
            }
            
            // Crear movimiento
            const movimiento = {
                ot: ot,
                tipo_movimiento: nuevoEstado === 'En Proceso' ? 'En Proceso' : 'Reasignado',
                responsable: 'Sistema',
                observaciones: `Estado cambiado a ${nuevoEstado}`,
                fecha_movimiento: obtenerTimestamp()
            };
            
            await supabaseClient
                .from('movimientos_condiciones')
                .insert([movimiento]);
            
            guardarDatosLocales();
            cargarHistorial();
            actualizarEstadisticasDashboard();
            
            alert(`✅ Reporte ${ot} cambiado a ${nuevoEstado}`);
        }
        
        async function marcarComoReparado(ot) {
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <h3 style="margin-bottom: 20px;"><i class="fas fa-check-circle"></i> Marcar como Reparado</h3>
                
                <div class="form-group">
                    <label class="required">Reparado por *</label>
                    <input type="text" id="reparado-por" class="form-control" placeholder="Nombre del técnico">
                </div>
                
                <div class="form-group">
                    <label>Fecha de Reparación</label>
                    <input type="datetime-local" id="fecha-reparacion" class="form-control" value="${new Date().toISOString().slice(0, 16)}">
                </div>
                
                <div class="form-group">
                    <label>Observaciones de la Reparación</label>
                    <textarea id="obs-reparacion" class="form-control" rows="3" placeholder="Detalles de la reparación realizada..."></textarea>
                </div>
                
                <!-- SECCIÓN PARA FOTOS DESPUÉS CON CÁMARA -->
                <div class="form-group">
                    <label><i class="fas fa-camera"></i> Foto después de la reparación *</label>
                    <p style="color: #7f8c8d; font-size: 12px; margin-bottom: 10px;">Es obligatorio tomar al menos una foto que muestre la reparación completada</p>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-warning" onclick="tomarFotoCamara('reparacion')">
                            <i class="fas fa-camera"></i> Usar Cámara
                        </button>
                        <button type="button" class="btn btn-info" onclick="abrirGaleriaReparacion()">
                            <i class="fas fa-images"></i> Seleccionar de Galería
                        </button>
                    </div>
                    
                    <input type="file" id="foto-despues-input" accept="image/*" capture="environment" multiple 
                           style="display: none;" onchange="previewRepairImages(event)">
                    
                    <div class="image-preview" id="repair-image-preview">
                        <!-- Vista previa de imágenes de reparación -->
                    </div>
                    
                    <div id="camera-preview" style="display: none; margin-top: 15px; text-align: center;">
                        <video id="camera-video" autoplay playsinline style="width: 100%; max-width: 300px; border-radius: 8px;"></video>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-success" onclick="capturarFoto()">
                                <i class="fas fa-camera"></i> Capturar Foto
                            </button>
                            <button class="btn btn-danger" onclick="cerrarCamara()" style="margin-left: 10px;">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                        <canvas id="camera-canvas" style="display: none;"></canvas>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="confirmarReparacion('${ot}')">
                        <i class="fas fa-check"></i> Confirmar Reparación
                    </button>
                    <button class="btn btn-secondary" onclick="cerrarModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            `;
            
            document.getElementById('conditionModal').style.display = 'flex';
        }
        
        function previewRepairImages(event) {
            const preview = document.getElementById('repair-image-preview');
            preview.innerHTML = '';
            
            const files = event.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'image-preview-item';
                    imgContainer.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button class="remove-image" onclick="removerImagenReparacion(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    preview.appendChild(imgContainer);
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        function tomarFotoCamara(tipo) {
            const cameraPreview = document.getElementById('camera-preview');
            const cameraVideo = document.getElementById('camera-video');
            
            cameraPreview.style.display = 'block';
            
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false 
            })
            .then(stream => {
                cameraStream = stream;
                cameraVideo.srcObject = stream;
            })
            .catch(error => {
                console.error('Error accediendo a la cámara:', error);
                alert('No se pudo acceder a la cámara. Por favor permite el acceso o usa la galería.');
                cameraPreview.style.display = 'none';
            });
        }
        
        function cerrarCamara() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('camera-preview').style.display = 'none';
        }
        
        function capturarFoto() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            const preview = document.getElementById('repair-image-preview');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            canvas.toBlob(blob => {
                const file = new File([blob], `reparacion_${Date.now()}.jpg`, { type: 'image/jpeg' });
                const url = URL.createObjectURL(blob);
                
                const imgContainer = document.createElement('div');
                imgContainer.className = 'image-preview-item';
                imgContainer.innerHTML = `
                    <img src="${url}" alt="Foto de reparación">
                    <button class="remove-image" onclick="removerImagenReparacion(this)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                preview.appendChild(imgContainer);
                
                imgContainer.setAttribute('data-blob', url);
                imgContainer.setAttribute('data-file-name', file.name);
                
                cerrarCamara();
                
            }, 'image/jpeg', 0.9);
        }
        
        function abrirGaleriaReparacion() {
            document.getElementById('foto-despues-input').click();
        }
        
        async function confirmarReparacion(ot) {
            const reparadoPor = document.getElementById('reparado-por').value;
            if (!reparadoPor) {
                alert('❌ Por favor ingresa el nombre de quien realizó la reparación');
                return;
            }
            
            const imagePreviews = document.querySelectorAll('#repair-image-preview .image-preview-item');
            if (imagePreviews.length === 0) {
                alert('❌ Por favor toma al menos una foto de la reparación completada');
                return;
            }
            
            showLoading(true, 'Completando reparación...');
            
            try {
                const fotosDespuesUrls = [];
                
                for (const imgContainer of imagePreviews) {
                    const img = imgContainer.querySelector('img');
                    const blobUrl = imgContainer.getAttribute('data-blob');
                    const fileName = imgContainer.getAttribute('data-file-name');
                    
                    let file;
                    
                    if (blobUrl) {
                        const response = await fetch(blobUrl);
                        const blob = await response.blob();
                        file = new File([blob], fileName || `reparacion_${ot}_${Date.now()}.jpg`, { 
                            type: 'image/jpeg' 
                        });
                    } else {
                        const response = await fetch(img.src);
                        const blob = await response.blob();
                        file = new File([blob], `reparacion_${ot}_${Date.now()}.jpg`, { 
                            type: 'image/jpeg' 
                        });
                    }
                    
                    const result = await subirFotoASupabase(file, ot, 'despues');
                    if (result.success) {
                        fotosDespuesUrls.push(result.url);
                    }
                }
                
                const updateData = {
                    estado: 'Reparado',
                    reparado_por: reparadoPor,
                    fecha_reparacion: document.getElementById('fecha-reparacion').value || obtenerTimestamp(),
                    observaciones_reparacion: document.getElementById('obs-reparacion').value
                };
                
                if (fotosDespuesUrls.length > 0) {
                    updateData.fotos_despues = fotosDespuesUrls;
                }
                
                const { error: errorReporte } = await supabaseClient
                    .from('condiciones_inseguras')
                    .update(updateData)
                    .eq('ot', ot);
                
                if (errorReporte) throw errorReporte;
                
                const movimientoReparacion = {
                    ot: ot,
                    tipo_movimiento: 'Reparado',
                    responsable: reparadoPor,
                    observaciones: `Reparación completada por ${reparadoPor}`,
                    fecha_movimiento: obtenerTimestamp()
                };
                
                const { error: errorMovimiento } = await supabaseClient
                    .from('movimientos_condiciones')
                    .insert([movimientoReparacion]);
                
                if (errorMovimiento) throw errorMovimiento;
                
                const reporte = reports.find(r => r.ot === ot);
                if (reporte) {
                    reporte.estado = 'Reparado';
                    reporte.reparado_por = reparadoPor;
                    reporte.fecha_reparacion = movimientoReparacion.fecha_movimiento;
                    reporte.fotos_despues = fotosDespuesUrls;
                }
                
                movements.push(movimientoReparacion);
                guardarDatosLocales();
                
                cerrarModal();
                alert(`✅ Reporte ${ot} marcado como reparado por ${reparadoPor}`);
                
                cargarHistorial();
                actualizarEstadisticasDashboard();
                
            } catch (error) {
                console.error('Error completando reparación:', error);
                alert('❌ Error al completar la reparación: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        function cerrarModal() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('conditionModal').style.display = 'none';
        }
        
        // ==============================================
        // FUNCIÓN PARA FILTRAR REPORTES POR PERÍODO
        // ==============================================
        function filtrarReportesPorPeriodo(periodo) {
            const hoy = new Date();
            const fechaLimite = new Date();
            
            switch(periodo) {
                case '7d':
                    fechaLimite.setDate(hoy.getDate() - 7);
                    break;
                case '30d':
                    fechaLimite.setDate(hoy.getDate() - 30);
                    break;
                case '90d':
                    fechaLimite.setDate(hoy.getDate() - 90);
                    break;
                case '180d':
                    fechaLimite.setDate(hoy.getDate() - 180);
                    break;
                case '1y':
                    fechaLimite.setDate(hoy.getDate() - 365);
                    break;
                default:
                    return reports;
            }
            
            return reports.filter(reporte => {
                const fechaReporte = new Date(reporte.fecha_reporte);
                return fechaReporte >= fechaLimite;
            });
        }
        
        // ==============================================
        // FUNCIONES PARA ANÁLISIS
        // ==============================================
        function cargarAnalisis() {
            actualizarKPIsAnalisis();
            actualizarGraficoSector();
            actualizarGraficoRiesgo();
            actualizarGraficoTendencia();
            actualizarGraficoTiempoReparacion();
            cargarTopSectores();
        }
        
        function actualizarAnalisis() {
            actualizarKPIsAnalisis();
            actualizarGraficoSector();
            actualizarGraficoRiesgo();
            actualizarGraficoTendencia();
            actualizarGraficoTiempoReparacion();
            cargarTopSectores();
            
            mostrarNotificacion('✅ Análisis actualizado', 'success');
        }
        
        function actualizarKPIsAnalisis() {
            const periodo = document.getElementById('analysis-period').value;
            const reportesFiltrados = periodo === 'all' ? reports : filtrarReportesPorPeriodo(periodo);
            
            const riesgosCriticos = reportesFiltrados.filter(r => r.nivel_riesgo === 'Crítico').length;
            const riesgosAltos = reportesFiltrados.filter(r => r.nivel_riesgo === 'Alto').length;
            
            const reparadosPeriodo = reportesFiltrados.filter(r => {
                if (r.estado !== 'Reparado') return false;
                if (!r.fecha_reparacion || !r.fecha_reporte) return false;
                
                const inicio = new Date(r.fecha_reporte);
                const fin = new Date(r.fecha_reparacion);
                
                if (isNaN(inicio.getTime()) || isNaN(fin.getTime())) return false;
                if (fin <= inicio) return false;
                
                return true;
            });
            
            let tiempoPromedio = 0;
            if (reparadosPeriodo.length > 0) {
                const totalDias = reparadosPeriodo.reduce((sum, reporte) => {
                    const inicio = new Date(reporte.fecha_reporte);
                    const fin = new Date(reporte.fecha_reparacion);
                    const diferenciaMs = fin.getTime() - inicio.getTime();
                    const dias = Math.floor(diferenciaMs / (1000 * 60 * 60 * 24));
                    return sum + dias;
                }, 0);
                tiempoPromedio = Math.round(totalDias / reparadosPeriodo.length);
            }
            
            let cumplimiento = 0;
            if (reparadosPeriodo.length > 0) {
                const cumplidos = reparadosPeriodo.filter(r => {
                    if (!r.fecha_estimada_reparacion || !r.fecha_reparacion) return false;
                    const estimada = new Date(r.fecha_estimada_reparacion);
                    const real = new Date(r.fecha_reparacion);
                    
                    if (isNaN(estimada.getTime()) || isNaN(real.getTime())) return false;
                    
                    return real <= estimada;
                });
                cumplimiento = Math.round((cumplidos.length / reparadosPeriodo.length) * 100);
            }
            
            document.getElementById('critical-risks').textContent = riesgosCriticos;
            document.getElementById('high-risks').textContent = riesgosAltos;
            document.getElementById('avg-repair-time-analysis').textContent = `${tiempoPromedio}d`;
            document.getElementById('compliance-rate-analysis').textContent = `${cumplimiento}%`;
        }
        
        function actualizarGraficoSector() {
            const ctx = document.getElementById('sector-chart');
            if (!ctx) return;
            
            if (sectorChart) {
                sectorChart.destroy();
            }
            
            const periodo = document.getElementById('analysis-period').value;
            const reportesFiltrados = periodo === 'all' ? reports : filtrarReportesPorPeriodo(periodo);
            
            const sectores = {};
            reportesFiltrados.forEach(reporte => {
                if (!sectores[reporte.sector]) {
                    sectores[reporte.sector] = 0;
                }
                sectores[reporte.sector]++;
            });
            
            const labels = Object.keys(sectores);
            const data = Object.values(sectores);
            const backgroundColors = labels.map(sector => CHART_COLORS.sector[sector] || '#95a5a6');
            
            sectorChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Reportes por Sector',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: '#7f8c8d',
                                stepSize: 1
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#2c3e50'
                            }
                        }
                    }
                }
            });
        }
        
        function actualizarGraficoRiesgo() {
            const ctx = document.getElementById('risk-level-chart');
            if (!ctx) return;
            
            if (riskLevelChart) {
                riskLevelChart.destroy();
            }
            
            const periodo = document.getElementById('analysis-period').value;
            const reportesFiltrados = periodo === 'all' ? reports : filtrarReportesPorPeriodo(periodo);
            
            const niveles = ['Crítico', 'Alto', 'Medio', 'Bajo'];
            const data = niveles.map(nivel => 
                reportesFiltrados.filter(r => r.nivel_riesgo === nivel).length
            );
            
            riskLevelChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: niveles,
                    datasets: [{
                        data: data,
                        backgroundColor: niveles.map(nivel => CHART_COLORS.risk[nivel]),
                        borderWidth: 2,
                        borderColor: 'white'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#2c3e50',
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function actualizarGraficoTendencia() {
            const ctx = document.getElementById('trend-chart');
            if (!ctx) return;
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            const meses = [];
            const datos = [];
            const hoy = new Date();
            
            for (let i = 11; i >= 0; i--) {
                const fecha = new Date(hoy.getFullYear(), hoy.getMonth() - i, 1);
                const mesStr = fecha.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' });
                meses.push(mesStr);
                
                const reportesMes = reports.filter(r => {
                    const fechaReporte = new Date(r.fecha_reporte);
                    return fechaReporte.getFullYear() === fecha.getFullYear() && 
                           fechaReporte.getMonth() === fecha.getMonth();
                });
                
                datos.push(reportesMes.length);
            }
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: meses,
                    datasets: [{
                        label: 'Reportes por mes',
                        data: datos,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: '#7f8c8d'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: '#2c3e50',
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }
        
        function actualizarGraficoTiempoReparacion() {
            const ctx = document.getElementById('repair-time-chart');
            if (!ctx) return;
            
            if (repairTimeChart) {
                repairTimeChart.destroy();
            }
            
            const periodo = document.getElementById('analysis-period').value;
            const reportesFiltrados = periodo === 'all' ? reports : filtrarReportesPorPeriodo(periodo);
            
            const tiempos = ['< 1 día', '1-3 días', '4-7 días', '1-2 semanas', '> 2 semanas'];
            const reparados = reportesFiltrados.filter(r => r.estado === 'Reparado' && r.fecha_reparacion && r.fecha_reporte);
            
            const data = tiempos.map(rango => {
                const reparadosRango = reparados.filter(r => {
                    const inicio = new Date(r.fecha_reporte);
                    const fin = new Date(r.fecha_reparacion);
                    const dias = Math.floor((fin - inicio) / (1000 * 60 * 60 * 24));
                    
                    if (rango === '< 1 día') return dias < 1;
                    if (rango === '1-3 días') return dias >= 1 && dias <= 3;
                    if (rango === '4-7 días') return dias >= 4 && dias <= 7;
                    if (rango === '1-2 semanas') return dias >= 8 && dias <= 14;
                    return dias > 14;
                });
                
                return reparadosRango.length;
            });
            
            repairTimeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: tiempos,
                    datasets: [{
                        label: 'Reportes reparados',
                        data: data,
                        backgroundColor: '#9b59b6',
                        borderColor: '#8e44ad',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: '#7f8c8d',
                                stepSize: 1
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#2c3e50'
                            }
                        }
                    }
                }
            });
        }
        
        function cargarTopSectores() {
            const tbody = document.querySelector('#top-sectors-table tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const periodo = document.getElementById('analysis-period').value;
            const reportesFiltrados = periodo === 'all' ? reports : filtrarReportesPorPeriodo(periodo);
            
            const sectores = {};
            reportesFiltrados.forEach(reporte => {
                if (!sectores[reporte.sector]) {
                    sectores[reporte.sector] = {
                        total: 0,
                        pendientes: 0,
                        enProceso: 0,
                        reparados: 0,
                        tiempos: []
                    };
                }
                
                sectores[reporte.sector].total++;
                if (reporte.estado === 'Pendiente') sectores[reporte.sector].pendientes++;
                if (reporte.estado === 'En Proceso') sectores[reporte.sector].enProceso++;
                if (reporte.estado === 'Reparado') {
                    sectores[reporte.sector].reparados++;
                    if (reporte.fecha_reparacion && reporte.fecha_reporte) {
                        const inicio = new Date(reporte.fecha_reporte);
                        const fin = new Date(reporte.fecha_reparacion);
                        const dias = Math.floor((fin - inicio) / (1000 * 60 * 60 * 24));
                        sectores[reporte.sector].tiempos.push(dias);
                    }
                }
            });
            
            const sectoresArray = Object.entries(sectores).map(([nombre, datos]) => ({
                nombre,
                ...datos,
                tiempoPromedio: datos.tiempos.length > 0 ? 
                    Math.round(datos.tiempos.reduce((a, b) => a + b, 0) / datos.tiempos.length) : 0
            }));
            
            sectoresArray.sort((a, b) => b.total - a.total);
            
            sectoresArray.slice(0, 10).forEach((sector, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${sector.nombre}</td>
                    <td>${sector.total}</td>
                    <td>${sector.pendientes}</td>
                    <td>${sector.enProceso}</td>
                    <td>${sector.reparados}</td>
                    <td>${sector.tiempoPromedio}d</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // ==============================================
        // FUNCIONES DE CONFIGURACIÓN
        // ==============================================
        function cargarConfiguracion() {
            const total = reports.length;
            const pendientes = reports.filter(r => r.estado === 'Pendiente').length;
            const diasSinAccidentes = calcularDiasSinAccidentes();
            
            const reportantes = new Set(reports.map(r => r.reportado_por));
            
            document.getElementById('total-reports-config').textContent = total;
            document.getElementById('pending-reports-config').textContent = pendientes;
            document.getElementById('active-reporters').textContent = reportantes.size;
            document.getElementById('accident-free-config').textContent = diasSinAccidentes;
            
            document.getElementById('notify-new').checked = CONFIG.notifications.new;
            document.getElementById('notify-overdue').checked = CONFIG.notifications.overdue;
            document.getElementById('notify-critical').checked = CONFIG.notifications.critical;
        }
        
        function guardarNotificaciones() {
            CONFIG.notifications.new = document.getElementById('notify-new').checked;
            CONFIG.notifications.overdue = document.getElementById('notify-overdue').checked;
            CONFIG.notifications.critical = document.getElementById('notify-critical').checked;
            
            localStorage.setItem('notifications_config', JSON.stringify(CONFIG.notifications));
            alert('✅ Configuración de notificaciones guardada');
        }
        
        function simularDatos() {
            const sectores = ['Producción', 'Almacén', 'Mantenimiento', 'Aceites', 'Oficinas'];
            const riesgos = ['Mecánico', 'Eléctrico', 'Químico', 'Ergonómico'];
            const niveles = ['Crítico', 'Alto', 'Medio', 'Bajo'];
            const estados = ['Pendiente', 'En Proceso', 'Reparado'];
            const nombres = ['Juan Pérez', 'María García', 'Carlos López', 'Ana Martínez', 'Pedro Rodríguez'];
            
            for (let i = 1; i <= 10; i++) {
                const fechaReporte = new Date();
                fechaReporte.setDate(fechaReporte.getDate() - Math.floor(Math.random() * 30));
                
                const reporte = {
                    ot: `OT-2024-${String(i).padStart(3, '0')}`,
                    reportado_por: nombres[Math.floor(Math.random() * nombres.length)],
                    fecha_reporte: fechaReporte.toISOString(),
                    descripcion: `Condición insegura ${i}: ${['Cable expuesto', 'Piso resbaladizo', 'Protección faltante', 'Equipo defectuoso'][Math.floor(Math.random() * 4)]}`,
                    sector: sectores[Math.floor(Math.random() * sectores.length)],
                    ubicacion_especifica: `Área ${Math.floor(Math.random() * 10) + 1}`,
                    tipo_riesgo: riesgos[Math.floor(Math.random() * riesgos.length)],
                    nivel_riesgo: niveles[Math.floor(Math.random() * niveles.length)],
                    fecha_estimada_reparacion: new Date(fechaReporte.getTime() + (7 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
                    prioridad: ['Alta', 'Media', 'Baja'][Math.floor(Math.random() * 3)],
                    observaciones: 'Observaciones de ejemplo',
                    estado: estados[Math.floor(Math.random() * estados.length)],
                    fecha_creacion: fechaReporte.toISOString()
                };
                
                if (reporte.estado === 'Reparado') {
                    const fechaReparacion = new Date(fechaReporte);
                    fechaReparacion.setDate(fechaReparacion.getDate() + Math.floor(Math.random() * 10) + 1);
                    reporte.fecha_reparacion = fechaReparacion.toISOString();
                    reporte.reparado_por = 'Técnico ' + ['A', 'B', 'C', 'D'][Math.floor(Math.random() * 4)];
                }
                
                if (reporte.estado === 'En Proceso') {
                    const fechaInicio = new Date(fechaReporte);
                    fechaInicio.setDate(fechaInicio.getDate() + 1);
                    reporte.fecha_inicio_proceso = fechaInicio.toISOString();
                }
                
                reports.push(reporte);
            }
            
            const accidenteFecha = new Date();
            accidenteFecha.setDate(accidenteFecha.getDate() - 45);
            accidents.push({
                fecha: accidenteFecha.toISOString(),
                descripcion: 'Caída desde altura',
                gravedad: 'Moderada',
                sector: 'Mantenimiento'
            });
            
            guardarDatosLocales();
            alert('✅ 10 reportes simulados generados. Recarga la página para ver los cambios.');
        }
        
        // ==============================================
        // FUNCIONES AUXILIARES
        // ==============================================
        function forzarActualizacion() {
            showLoading(true, 'Actualizando datos...');
            
            setTimeout(() => {
                if (supabaseClient) {
                    sincronizarDatos();
                } else {
                    actualizarEstadisticasDashboard();
                    
                    if (document.getElementById('dashboard-page').classList.contains('active')) {
                        cargarActividadesRecientes();
                        actualizarGraficoEvolucion();
                    } else if (document.getElementById('historial-page').classList.contains('active')) {
                        cargarHistorial();
                    } else if (document.getElementById('analisis-page').classList.contains('active')) {
                        cargarAnalisis();
                    }
                    
                    showLoading(false);
                    mostrarNotificacion('✅ Datos actualizados desde almacenamiento local', 'success');
                }
            }, 500);
        }
        
        async function registrarAccidente() {
            const descripcion = prompt('Descripción del accidente:');
            if (!descripcion) return;
            
            const gravedad = prompt('Gravedad (Leve, Moderada, Grave):', 'Moderada');
            const sector = prompt('Sector donde ocurrió:', 'Producción');
            
            const nuevoAccidente = {
                fecha: obtenerTimestamp(),
                descripcion: descripcion,
                gravedad: gravedad,
                sector: sector
            };
            
            try {
                const { data, error } = await supabaseClient
                    .from('accidentes')
                    .insert([nuevoAccidente]);
                
                if (error) throw error;
                
                accidents.push(nuevoAccidente);
                guardarDatosLocales();
                
                alert('⚠️ Accidente registrado. Se reiniciará el contador de días sin accidentes.');
                actualizarDiasSinAccidentes();
                
            } catch (error) {
                console.error('Error guardando accidente:', error);
                alert('❌ Error al guardar el accidente: ' + error.message);
            }
        }
        
        // ==============================================
        // FUNCIONES DE ALMACENAMIENTO LOCAL
        // ==============================================
        function guardarDatosLocales() {
            try {
                localStorage.setItem('condiciones_inseguras', JSON.stringify({
                    reports: reports,
                    movements: movements,
                    accidents: accidents,
                    lastUpdated: new Date().toISOString()
                }));
            } catch (error) {
                console.error('Error guardando datos locales:', error);
            }
        }
        
        function cargarDatosLocales() {
            try {
                const datosGuardados = localStorage.getItem('condiciones_inseguras');
                if (datosGuardados) {
                    const datos = JSON.parse(datosGuardados);
                    reports = datos.reports || [];
                    movements = datos.movements || [];
                    accidents = datos.accidents || [];
                    
                    if (supabaseClient && !CONFIG.offlineMode) {
                        cargarAccidentesDesdeSupabase();
                    }
                } else {
                    reports = [];
                    movements = [];
                    accidents = [];
                }
                
                const notificacionesGuardadas = localStorage.getItem('notifications_config');
                if (notificacionesGuardadas) {
                    CONFIG.notifications = JSON.parse(notificacionesGuardadas);
                }
                
            } catch (error) {
                console.error('Error cargando datos locales:', error);
                reports = [];
                movements = [];
                accidents = [];
            }
        }
        
        async function cargarAccidentesDesdeSupabase() {
            try {
                if (!supabaseClient || CONFIG.offlineMode) return;
                
                const { data, error } = await supabaseClient
                    .from('accidentes')
                    .select('*')
                    .order('fecha', { ascending: false });
                
                if (error) {
                    if (!error.message.includes('does not exist')) {
                        throw error;
                    }
                    console.log('📋 Tabla de accidentes no existe aún');
                    return;
                }
                
                if (data) {
                    accidents = data;
                    guardarDatosLocales();
                    console.log(`📊 Accidentes cargados desde Supabase: ${accidents.length}`);
                }
            } catch (error) {
                console.error('Error cargando accidentes:', error);
            }
        }
        
        // ==============================================
        // FUNCIONES DE SINCRONIZACIÓN
        // ==============================================
        async function sincronizarDatos() {
            if (!supabaseClient || CONFIG.offlineMode) {
                console.log('⏸️  Sincronización omitida - Modo offline');
                return;
            }
            
            showLoading(true, 'Sincronizando con Supabase...');
            
            try {
                const { data: remoteReports, error: reportsError } = await supabaseClient
                    .from('condiciones_inseguras')
                    .select('*')
                    .order('fecha_reporte', { ascending: false });
                
                if (reportsError) throw reportsError;
                
                if (remoteReports) {
                    reports = remoteReports.map(reporte => {
                        if (reporte.fecha_reparacion && reporte.fecha_reporte) {
                            const inicio = new Date(reporte.fecha_reporte);
                            const fin = new Date(reporte.fecha_reparacion);
                            
                            if (fin < inicio && !isNaN(inicio.getTime()) && !isNaN(fin.getTime())) {
                                console.warn(`Corrigiendo fechas para OT ${reporte.ot}: ${fin} < ${inicio}`);
                                const temp = reporte.fecha_reporte;
                                reporte.fecha_reporte = reporte.fecha_reparacion;
                                reporte.fecha_reparacion = temp;
                            }
                        }
                        return reporte;
                    });
                }
                
                const { data: remoteMovements, error: movementsError } = await supabaseClient
                    .from('movimientos_condiciones')
                    .select('*')
                    .order('fecha_movimiento', { ascending: false });
                
                if (movementsError && !movementsError.message.includes('does not exist')) {
                    console.error('Error descargando movimientos:', movementsError);
                }
                
                await cargarAccidentesDesdeSupabase();
                
                if (remoteMovements) movements = remoteMovements;
                
                guardarDatosLocales();
                
                CONFIG.lastSync = new Date().toLocaleString('es-ES');
                localStorage.setItem('last_sync', CONFIG.lastSync);
                
                console.log(`✅ Sincronización completada: ${reports.length} reportes, ${accidents.length} accidentes`);
                
                actualizarEstadisticasDashboard();
                
                if (document.getElementById('dashboard-page').classList.contains('active')) {
                    cargarDashboard();
                }
                
                mostrarNotificacion('✅ Sincronización completada', 'success');
                
            } catch (error) {
                console.error('❌ Error en sincronización:', error);
                CONFIG.offlineMode = true;
                updateStatusIndicator('error', 'Error de sincronización');
                mostrarNotificacion('❌ Error sincronizando con Supabase', 'error');
                
            } finally {
                showLoading(false);
            }
        }
        
        // ==============================================
        // FUNCIONES DE NOTIFICACIÓN
        // ==============================================
        function mostrarNotificacion(mensaje, tipo = 'info') {
            const notificacion = document.createElement('div');
            notificacion.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            
            if (tipo === 'success') {
                notificacion.style.backgroundColor = '#27ae60';
            } else if (tipo === 'error') {
                notificacion.style.backgroundColor = '#e74c3c';
            } else if (tipo === 'warning') {
                notificacion.style.backgroundColor = '#f39c12';
            } else {
                notificacion.style.backgroundColor = '#3498db';
            }
            
            notificacion.innerHTML = `
                <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'exclamation-triangle' : tipo === 'warning' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${mensaje}</span>
            `;
            
            document.body.appendChild(notificacion);
            
            setTimeout(() => {
                notificacion.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notificacion.parentNode) {
                        notificacion.parentNode.removeChild(notificacion);
                    }
                }, 300);
            }, 5000);
            
            if (!document.getElementById('notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // ==============================================
        // INICIALIZACIÓN
        // ==============================================
        async function inicializarApp() {
            console.log('🚀 Inicializando Sistema de Condiciones Inseguras...');
            showLoading(true, 'Iniciando sistema...');
            
            try {
                supabaseClient = supabase.createClient(
                    MIS_CREDENCIALES.URL,
                    MIS_CREDENCIALES.API_KEY,
                    {
                        auth: {
                            persistSession: false,
                            autoRefreshToken: false,
                            detectSessionInUrl: false
                        },
                        global: {
                            headers: {
                                'apikey': MIS_CREDENCIALES.API_KEY,
                                'Authorization': `Bearer ${MIS_CREDENCIALES.API_KEY}`
                            }
                        }
                    }
                );
                
                console.log('🔗 Cliente Supabase creado');
                
                try {
                    const { data, error } = await supabaseClient
                        .from('condiciones_inseguras')
                        .select('*')
                        .limit(1);
                    
                    if (error) {
                        if (error.message.includes('does not exist')) {
                            console.log('📋 Tabla no existe, pero conexión OK');
                            updateStatusIndicator('connected', 'Conectado a Supabase');
                            CONFIG.offlineMode = false;
                        } else if (error.message.includes('row-level security')) {
                            console.log('🔐 Error RLS detectado, pero conexión funciona');
                            updateStatusIndicator('connected', 'Conectado (RLS necesita ajuste)');
                            CONFIG.offlineMode = false;
                        } else {
                            throw error;
                        }
                    } else {
                        console.log('✅ Conexión exitosa con Supabase');
                        updateStatusIndicator('connected', 'Conectado a Supabase');
                        CONFIG.offlineMode = false;
                    }
                } catch (testError) {
                    console.log('⚠️  Error en prueba inicial:', testError.message);
                    
                    try {
                        const { data: testData, error: testError2 } = await supabaseClient
                            .from('sectores')
                            .select('*')
                            .limit(1);
                        
                        if (!testError2) {
                            console.log('✅ Conexión funciona con tabla sectores');
                            updateStatusIndicator('connected', 'Conectado a Supabase');
                            CONFIG.offlineMode = false;
                        } else {
                            throw testError;
                        }
                    } catch {
                        console.log('🔌 Modo offline - Usando datos locales');
                        updateStatusIndicator('disconnected', 'Modo Offline');
                        CONFIG.offlineMode = true;
                    }
                }
                
                cargarDatosLocales();
                console.log(`📊 Datos locales cargados: ${reports.length} reportes`);
                
                if (!CONFIG.offlineMode) {
                    try {
                        await sincronizarDatos();
                    } catch (syncError) {
                        console.log('⚠️  Error en sincronización:', syncError.message);
                        CONFIG.offlineMode = true;
                    }
                }
                
                configurarInterfaz();
                cambiarPagina('dashboard');
                
                CONFIG.initialized = true;
                console.log('✅ Sistema inicializado correctamente');
                
                if (CONFIG.offlineMode) {
                    mostrarNotificacion('⚠️ Modo offline activado', 'warning');
                } else {
                    mostrarNotificacion('✅ Sistema conectado a Supabase', 'success');
                }
                
            } catch (error) {
                console.error('❌ Error crítico en inicialización:', error);
                updateStatusIndicator('error', 'Error de inicialización');
                
                cargarDatosLocales();
                configurarInterfaz();
                cambiarPagina('dashboard');
                
                mostrarNotificacion('⚠️ Error de conexión. Modo offline activado.', 'error');
                
            } finally {
                showLoading(false);
            }
        }
        
        function configurarInterfaz() {
            document.querySelectorAll('.nav-menu a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pagina = link.getAttribute('data-page');
                    cambiarPagina(pagina);
                });
            });
            
            const reportForm = document.getElementById('report-form');
            if (reportForm) {
                reportForm.addEventListener('submit', manejarRegistroReporte);
            }
            
            document.getElementById('filter-all')?.addEventListener('click', () => {
                currentFilter = 'all';
                cargarHistorial();
            });
            
            document.getElementById('filter-pending')?.addEventListener('click', () => {
                currentFilter = 'pending';
                cargarHistorial();
            });
            
            document.getElementById('filter-inprogress')?.addEventListener('click', () => {
                currentFilter = 'inprogress';
                cargarHistorial();
            });
            
            document.getElementById('filter-repaired')?.addEventListener('click', () => {
                currentFilter = 'repaired';
                cargarHistorial();
            });
            
            document.getElementById('search-reports')?.addEventListener('input', cargarHistorial);
            document.getElementById('filter-sector')?.addEventListener('change', cargarHistorial);
            document.getElementById('filter-risk-level')?.addEventListener('change', cargarHistorial);
            
            document.getElementById('time-period')?.addEventListener('change', function() {
                actualizarGraficoEvolucion();
                mostrarNotificacion('✅ Gráfico actualizado automáticamente', 'success');
            });
            
            document.getElementById('analysis-period')?.addEventListener('change', function() {
                actualizarAnalisis();
                mostrarNotificacion('✅ Análisis actualizado con el nuevo período', 'success');
            });
            
            document.getElementById('analysis-type')?.addEventListener('change', function() {
                actualizarAnalisis();
                mostrarNotificacion('✅ Tipo de análisis actualizado', 'success');
            });
            
            const fechaReporte = document.getElementById('report-date');
            if (fechaReporte && !fechaReporte.value) {
                fechaReporte.value = new Date().toISOString().slice(0, 16);
            }
            
            const fechaEstimada = document.getElementById('estimated-repair-date');
            if (fechaEstimada && !fechaEstimada.value) {
                const hoy = new Date();
                hoy.setDate(hoy.getDate() + 7);
                fechaEstimada.value = hoy.toISOString().split('T')[0];
                fechaEstimada.min = new Date().toISOString().split('T')[0];
            }
        }
        
        // ==============================================
        // INICIALIZAR AL CARGAR LA PÁGINA
        // ==============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 Página cargada, iniciando aplicación...');
            inicializarApp();
            
            setTimeout(() => {
                if (!supabaseClient && CONFIG.supabaseUrl) {
                    if (!CONFIG.initialized) {
                        mostrarNotificacion('⚠️ Problemas de conexión detectados.', 'error');
                    }
                }
            }, 3000);
        });
        
        window.addEventListener('online', () => {
            console.log('🌐 Conexión a Internet restablecida');
            if (supabaseClient) {
                updateStatusIndicator('connected', 'Reconectando...');
                sincronizarDatos();
            }
        });
        
        window.addEventListener('offline', () => {
            console.log('📴 Sin conexión a Internet');
            updateStatusIndicator('disconnected', 'Sin conexión - Modo Offline');
            CONFIG.offlineMode = true;
        });
    </script>
</body>
</html>
